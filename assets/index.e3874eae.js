import{e as B,o as _,k as T,i as D,a as k,b as z,f as $,s as C,t as F,u as y,l as q,h as J,m as O,j as H,n as K,c as E,F as Q,S as W}from"./index.5bb5cc04.js";import{U as X}from"./url-transformer.f8d61888.js";const Y=e=>{if(e<=0||e>=1)return[];const n=[];let o=0;for(;o<1;)n.push(o),o+=e;return n.push(1),n},Z="_root_1jepb_1",ee="_image_1jepb_50",ne="_unload_1jepb_58",te="_loading_1jepb_78",S={root:Z,image:ee,unload:ne,loading:te};var re=F("<div><img>");const ae=e=>[],oe=e=>{let n;const[o,i]=B("unload");_(()=>{!n||(n.src="")});const c=()=>{i("loaded"),e.onLoaded?.()},s=()=>{i("error"),e.onError?.()},a=new ResizeObserver(r=>{r.forEach(l=>{const f=l.contentBoxSize[0].blockSize;o()!=="unload"||f===0||(e.onLoadStart?.(),i("loading"))})});T(()=>{!n||a.observe(n)}),_(()=>a.disconnect());let d;const t=new IntersectionObserver(r=>{r.forEach(l=>{const{boundingClientRect:f,intersectionRatio:p,isIntersecting:g}=l;e.onIntersect?.({boundingClientRect:f,intersectionRatio:p,isIntersecting:g})})},{threshold:Y(1e-4)});return T(()=>{!d||t.observe(d)}),_(()=>t.disconnect()),(()=>{var r=re(),l=r.firstChild,f=d;typeof f=="function"?y(f,r):d=r,D(r,()=>ae(e.id),l),l.addEventListener("error",s),l.addEventListener("load",c);var p=n;return typeof p=="function"?y(p,l):n=l,k(g=>{var h=S.image,w={[S.unload]:o()==="unload",[S.loading]:o()==="loading"},v=e.id,I=e.src,x=e.alt;return h!==g.e&&z(r,g.e=h),g.t=$(r,w,g.t),v!==g.a&&C(r,"data-id",g.a=v),I!==g.o&&C(l,"src",g.o=I),x!==g.i&&C(l,"alt",g.i=x),g},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),r})()},P=e=>JSON.stringify(e,Object.keys(e).sort()),se=()=>{const e=q();if(!Number.isNaN(Number.parseInt(e.chapterIndex,10))&&!Number.isNaN(Number.parseInt(e.pageIndex,10)))return{mangaId:e.mangaId,chapterIndex:Number.parseInt(e.chapterIndex,10),pageIndex:Number.parseInt(e.pageIndex,10)}},R=(e,n,o,i)=>{if(o===0)return[];const{pageIndex:u,chapterIndex:c}=e,s=i.find(t=>t.index===c),a=t=>{const r=R(t,n,o-1,i);return n==="prev"?[...r,t]:[t,...r]};if(n==="prev"){if(u!==1)return a({...e,pageIndex:u-1});const t=i.find(r=>r.index===s?.prevIndex);return t?a({...e,chapterIndex:t.index,pageIndex:t.total}):[]}if(typeof s?.total<"u"&&u!==s.total)return a({...e,pageIndex:u+1});const d=i.find(t=>t.index===s?.nextIndex);return d?a({...e,chapterIndex:d.index,pageIndex:1}):[]},N=(e,n)=>P(e)===P(n),A=(e,n)=>e.mangaId!==n.mangaId?!1:e.chapterIndex!==n.chapterIndex?n.chapterIndex<e.chapterIndex:n.pageIndex<e.pageIndex,U=e=>{if(!e)return;const n=[...e.children].map(o=>{try{const i=JSON.parse(o.dataset.id??"null");if(!i)return;const{top:u,height:c}=o.getBoundingClientRect();return{pageInfo:i,height:c,clientTop:u,element:o}}catch{return}});if(!n.includes(void 0))return n.filter(o=>!!o)},ie=(e,n)=>e.reduce((o,i)=>o+i.height,-n),j=2,de=()=>{const e=J(),[n,o]=B(se()),i=O(()=>{if(e.state!=="ready")return;const s=n();if(!!s)return e().find(a=>a.id===s.mangaId)});H(()=>{const s=i();!s||(document.title=s.title)});const u=O(()=>{const s=n();if(!s)return[];const a=i();return a?[...R(s,"prev",j,a.chapters),s,...R(s,"next",j,a.chapters)]:[]});return{mangaInfo:i,mangaResource:e,readingInfo:n,displayPageImages:u,handleReadingInfoChange:(s,a)=>{const d=n();if(!d)return;const t=i();if(!t)return;const r=R(d,s,1,t.chapters)[0];!r||(o(r),K(r),a?.())}}},ce="_read-view_v2xka_1",le={readView:ce};var ue=F("<div>");const ge=.05,me=()=>{const{mangaResource:e,readingInfo:n,displayPageImages:o,handleReadingInfoChange:i}=de();let u,c;T(()=>{const a=n();if(!a)return;const d=U(c);if(!d)return;const t=d.find(r=>N(r.pageInfo,a));u=0,t?.element.scrollIntoView(!0)});const s=a=>{const{pageInfo:d,boundingClientRect:t,intersectionRatio:r}=a,l=n();if(!l||!N(l,d)||u===t.top||(u=t.top,r>=ge)||!c)return;const f=t.top>0?"prev":"next",p=l,g=c.scrollTop,h=u;i(f,()=>requestAnimationFrame(()=>{if(!c)return;const v=c.scrollTop-g,I=U(c);if(!I)return;const x=I.filter(m=>A(p,m.pageInfo)),b=I.findIndex(m=>N(l,m.pageInfo));if(b===-1)return;const G=f==="prev"?Math.max(b-1,-1):Math.min(b+1,I.length),L=I[G],M=ie(x,h-v);c?.scrollTo({top:M}),u=I.filter(m=>A(L.pageInfo,m.pageInfo)).reduce((m,V)=>m+V.height,-M)}))};return E(W,{get when(){return!e.loading},get children(){var a=ue(),d=c;return typeof d=="function"?y(d,a):c=a,D(a,E(Q,{get each(){return o()},children:t=>E(oe,{get id(){return P(t)},get src(){return X.getPageImage(t)},containerRef:c,onIntersect:r=>s({...r,pageInfo:t})})})),k(()=>z(a,le.readView)),a}})};export{me as default};
