import{e as z,o as $,k as P,a as U,b as L,f as F,s as b,t as q,u as T,l as k,h as D,m as A,n as G,c as E,i as V,F as J,S as H}from"./index.c12ade2a.js";import{U as j}from"./url-transformer.6b2c128d.js";const K=e=>{if(e<=0||e>=1)return[];const n=[];let o=0;for(;o<1;)n.push(o),o+=e;return n.push(1),n},Q="_root_19szn_1",W="_image_19szn_50",X="_unload_19szn_57",Y="_loading_19szn_77",y={root:Q,image:W,unload:X,loading:Y},Z=q("<div><img>"),ee=e=>{let n;const[o,s]=z("unload");$(()=>{!n||(n.src="")});const l=()=>{s("loaded"),e.onLoaded?.()},i=()=>{s("error"),e.onError?.()},c=new ResizeObserver(t=>{t.forEach(d=>{const f=d.contentBoxSize[0].blockSize;o()!=="unload"||f===0||(e.onLoadStart?.(),s("loading"))})});P(()=>{!n||c.observe(n)}),$(()=>c.disconnect());let a;const r=new IntersectionObserver(t=>{t.forEach(d=>{const{boundingClientRect:f,intersectionRatio:I,isIntersecting:g}=d;e.onIntersect?.({boundingClientRect:f,intersectionRatio:I,isIntersecting:g})})},{threshold:K(1e-4)});return P(()=>{!a||r.observe(a)}),$(()=>r.disconnect()),(()=>{const t=Z(),d=t.firstChild,f=a;typeof f=="function"?T(f,t):a=t,d.addEventListener("error",i),d.addEventListener("load",l);const I=n;return typeof I=="function"?T(I,d):n=d,U(g=>{const h=y.image,m={[y.unload]:o()==="unload",[y.loading]:o()==="loading"},v=e.id,p=e.src,R=e.alt;return h!==g._v$&&L(t,g._v$=h),g._v$2=F(t,m,g._v$2),v!==g._v$3&&b(t,"data-id",g._v$3=v),p!==g._v$4&&b(d,"src",g._v$4=p),R!==g._v$5&&b(d,"alt",g._v$5=R),g},{_v$:void 0,_v$2:void 0,_v$3:void 0,_v$4:void 0,_v$5:void 0}),t})()},w=e=>JSON.stringify(e,Object.keys(e).sort()),ne=()=>{const e=k();if(!Number.isNaN(Number.parseInt(e.chapterIndex,10))&&!Number.isNaN(Number.parseInt(e.pageIndex,10)))return{mangaId:e.mangaId,chapterIndex:Number.parseInt(e.chapterIndex,10),pageIndex:Number.parseInt(e.pageIndex,10)}},x=(e,n,o,s)=>{if(o===0)return[];const{pageIndex:u,chapterIndex:l}=e,i=s.find(r=>r.index===l),c=r=>{const t=x(r,n,o-1,s);return n==="prev"?[...t,r]:[r,...t]};if(n==="prev"){if(u!==1)return c({...e,pageIndex:u-1});const r=s.find(t=>t.index===i?.prevIndex);return r?c({...e,chapterIndex:r.index,pageIndex:r.total}):[]}if(typeof i?.total<"u"&&u!==i.total)return c({...e,pageIndex:u+1});const a=s.find(r=>r.index===i?.nextIndex);return a?c({...e,chapterIndex:a.index,pageIndex:1}):[]},N=(e,n)=>w(e)===w(n),S=(e,n)=>e.mangaId!==n.mangaId?!1:e.chapterIndex!==n.chapterIndex?n.chapterIndex<e.chapterIndex:n.pageIndex<e.pageIndex,C=e=>{if(!e)return;const n=[...e.children].map(o=>{try{const s=JSON.parse(o.dataset.id??"null");if(!s)return;const{top:u,height:l}=o.getBoundingClientRect();return{pageInfo:s,height:l,clientTop:u,element:o}}catch{return}});if(!n.includes(void 0))return n.filter(o=>!!o)},M=(e,n)=>e.reduce((o,s)=>o+s.height,-n),O=2,te=()=>{const e=D(),[n,o]=z(ne()),s=A(()=>{if(e.state!=="ready")return;const i=n();if(!!i)return e().find(c=>c.id===i.mangaId)}),u=A(()=>{const i=n();if(!i)return[];const c=s();return c?[...x(i,"prev",O,c.chapters),i,...x(i,"next",O,c.chapters)]:[]});return{mangaInfo:s,mangaResource:e,readingInfo:n,displayPageImages:u,handleReadingInfoChange:(i,c)=>{const a=n();if(!a)return;const r=s();if(!r)return;const t=x(a,i,1,r.chapters)[0];!t||(o(t),G(t),c?.())}}},re="_read-view_v2xka_1",ae={readView:re},oe=q("<div>"),se=.25,ce=()=>{const{mangaResource:e,readingInfo:n,displayPageImages:o,handleReadingInfoChange:s}=te();let u,l;P(()=>{const a=n();if(!a)return;const r=C(l);if(!r)return;const t=r.find(d=>N(d.pageInfo,a));u=0,requestAnimationFrame(()=>{t?.element.scrollIntoView(!0)})});const i=a=>{const r=n();if(!r||!S(r,a))return;const t=C(l);if(!t)return;const d=t.filter(f=>S(r,f.pageInfo));requestAnimationFrame(()=>{l?.scrollTo({top:M(d,u)})})},c=a=>{const{pageInfo:r,boundingClientRect:t,intersectionRatio:d}=a,f=n();if(!f||!N(f,r)||u===t.top||(u=t.top,d>=se))return;const I=t.top>0?"prev":"next",g=u,h=f;s(I,()=>requestAnimationFrame(()=>{const m=C(l);if(!m)return;const v=m.filter(_=>S(h,_.pageInfo)),p=m.findIndex(_=>N(f,_.pageInfo));if(p===-1)return;const R=I==="prev"?Math.max(p-1,-1):Math.min(p+1,m.length),B=m[R];l?.scrollTo({top:M(v,g)}),u=B.clientTop}))};return E(H,{get when(){return!e.loading},get children(){const a=oe(),r=l;return typeof r=="function"?T(r,a):l=a,V(a,E(J,{get each(){return o()},children:t=>E(ee,{get id(){return w(t)},get src(){return j.getPageImage(t)},containerRef:l,onLoadStart:()=>i(t),onIntersect:d=>c({...d,pageInfo:t})})})),U(()=>L(a,ae.readView)),a}})};export{ce as default};
