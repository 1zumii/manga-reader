import{e as j,o as b,k as N,i as B,a as D,b as k,f as V,s as C,t as z,u as T,l as q,h as J,m as M,j as H,n as K,c as $,F as Q,S as W}from"./index.b6b82706.js";import{U as X}from"./url-transformer.6b2c128d.js";const Y=e=>{if(e<=0||e>=1)return[];const n=[];let a=0;for(;a<1;)n.push(a),a+=e;return n.push(1),n},Z="_root_1jepb_1",ee="_image_1jepb_50",ne="_unload_1jepb_58",te="_loading_1jepb_78",E={root:Z,image:ee,unload:ne,loading:te},re=z("<div><img>"),oe=e=>[],ae=e=>{let n;const[a,i]=j("unload");b(()=>{!n||(n.src="")});const d=()=>{i("loaded"),e.onLoaded?.()},s=()=>{i("error"),e.onError?.()},o=new ResizeObserver(r=>{r.forEach(u=>{const f=u.contentBoxSize[0].blockSize;a()!=="unload"||f===0||(e.onLoadStart?.(),i("loading"))})});N(()=>{!n||o.observe(n)}),b(()=>o.disconnect());let c;const t=new IntersectionObserver(r=>{r.forEach(u=>{const{boundingClientRect:f,intersectionRatio:p,isIntersecting:g}=u;e.onIntersect?.({boundingClientRect:f,intersectionRatio:p,isIntersecting:g})})},{threshold:Y(1e-4)});return N(()=>{!c||t.observe(c)}),b(()=>t.disconnect()),(()=>{const r=re(),u=r.firstChild,f=c;typeof f=="function"?T(f,r):c=r,B(r,()=>oe(e.id),u),u.addEventListener("error",s),u.addEventListener("load",d);const p=n;return typeof p=="function"?T(p,u):n=u,D(g=>{const h=E.image,P={[E.unload]:a()==="unload",[E.loading]:a()==="loading"},v=e.id,I=e.src,x=e.alt;return h!==g._v$&&k(r,g._v$=h),g._v$2=V(r,P,g._v$2),v!==g._v$3&&C(r,"data-id",g._v$3=v),I!==g._v$4&&C(u,"src",g._v$4=I),x!==g._v$5&&C(u,"alt",g._v$5=x),g},{_v$:void 0,_v$2:void 0,_v$3:void 0,_v$4:void 0,_v$5:void 0}),r})()},y=e=>JSON.stringify(e,Object.keys(e).sort()),se=()=>{const e=q();if(!Number.isNaN(Number.parseInt(e.chapterIndex,10))&&!Number.isNaN(Number.parseInt(e.pageIndex,10)))return{mangaId:e.mangaId,chapterIndex:Number.parseInt(e.chapterIndex,10),pageIndex:Number.parseInt(e.pageIndex,10)}},R=(e,n,a,i)=>{if(a===0)return[];const{pageIndex:l,chapterIndex:d}=e,s=i.find(t=>t.index===d),o=t=>{const r=R(t,n,a-1,i);return n==="prev"?[...r,t]:[t,...r]};if(n==="prev"){if(l!==1)return o({...e,pageIndex:l-1});const t=i.find(r=>r.index===s?.prevIndex);return t?o({...e,chapterIndex:t.index,pageIndex:t.total}):[]}if(typeof s?.total<"u"&&l!==s.total)return o({...e,pageIndex:l+1});const c=i.find(t=>t.index===s?.nextIndex);return c?o({...e,chapterIndex:c.index,pageIndex:1}):[]},S=(e,n)=>y(e)===y(n),O=(e,n)=>e.mangaId!==n.mangaId?!1:e.chapterIndex!==n.chapterIndex?n.chapterIndex<e.chapterIndex:n.pageIndex<e.pageIndex,A=e=>{if(!e)return;const n=[...e.children].map(a=>{try{const i=JSON.parse(a.dataset.id??"null");if(!i)return;const{top:l,height:d}=a.getBoundingClientRect();return{pageInfo:i,height:d,clientTop:l,element:a}}catch{return}});if(!n.includes(void 0))return n.filter(a=>!!a)},ie=(e,n)=>e.reduce((a,i)=>a+i.height,-n),U=2,ce=()=>{const e=J(),[n,a]=j(se()),i=M(()=>{if(e.state!=="ready")return;const s=n();if(!!s)return e().find(o=>o.id===s.mangaId)});H(()=>{const s=i();!s||(document.title=s.title)});const l=M(()=>{const s=n();if(!s)return[];const o=i();return o?[...R(s,"prev",U,o.chapters),s,...R(s,"next",U,o.chapters)]:[]});return{mangaInfo:i,mangaResource:e,readingInfo:n,displayPageImages:l,handleReadingInfoChange:(s,o)=>{const c=n();if(!c)return;const t=i();if(!t)return;const r=R(c,s,1,t.chapters)[0];!r||(a(r),K(r),o?.())}}},de="_read-view_v2xka_1",ue={readView:de},le=z("<div>"),ge=.05,me=()=>{const{mangaResource:e,readingInfo:n,displayPageImages:a,handleReadingInfoChange:i}=ce();let l,d;N(()=>{const o=n();if(!o)return;const c=A(d);if(!c)return;const t=c.find(r=>S(r.pageInfo,o));l=0,t?.element.scrollIntoView(!0)});const s=o=>{const{pageInfo:c,boundingClientRect:t,intersectionRatio:r}=o,u=n();if(!u||!S(u,c)||l===t.top||(l=t.top,r>=ge)||!d)return;const f=t.top>0?"prev":"next",p=u,g=d.scrollTop,h=l;i(f,()=>requestAnimationFrame(()=>{if(!d)return;const v=d.scrollTop-g,I=A(d);if(!I)return;const x=I.filter(m=>O(p,m.pageInfo)),_=I.findIndex(m=>S(u,m.pageInfo));if(_===-1)return;const F=f==="prev"?Math.max(_-1,-1):Math.min(_+1,I.length),G=I[F],w=ie(x,h-v);d?.scrollTo({top:w}),l=I.filter(m=>O(G.pageInfo,m.pageInfo)).reduce((m,L)=>m+L.height,-w)}))};return $(W,{get when(){return!e.loading},get children(){const o=le(),c=d;return typeof c=="function"?T(c,o):d=o,B(o,$(Q,{get each(){return a()},children:t=>$(ae,{get id(){return y(t)},get src(){return X.getPageImage(t)},containerRef:d,onIntersect:r=>s({...r,pageInfo:t})})})),D(()=>k(o,ue.readView)),o}})};export{me as default};
