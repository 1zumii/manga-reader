import{e as O,o as y,j as C,i as U,a as z,b as B,f as D,s as b,t as F,u as w,k as G,g as V,h as q,l as L,c as $,F as J,S as j}from"./index.3b9398d0.js";import{U as H}from"./url-transformer.6b2c128d.js";const K=e=>{if(e<=0||e>=1)return[];const t=[];let a=0;for(;a<1;)t.push(a),a+=e;return t.push(1),t},Q="_root_15f8k_1",W="_image_15f8k_36",X="_unload_15f8k_43",Y="_loading_15f8k_63",P={root:Q,image:W,unload:X,loading:Y},Z=F("<div><pre></pre><img>"),ee=e=>{let t;const[a,s]=O("unload");y(()=>{!t||(t.src="")});const u=()=>{s("loaded"),e.onLoaded?.()},l=()=>{s("error"),e.onError?.()},i=new ResizeObserver(n=>{n.forEach(r=>{const c=r.contentBoxSize[0].blockSize;a()!=="unload"||c===0||(e.onLoadStart?.(),s("loading"))})});C(()=>{!t||i.observe(t)}),y(()=>i.disconnect());let d;const o=new IntersectionObserver(n=>{n.forEach(r=>{if(!r.isIntersecting)return;const{boundingClientRect:c,intersectionRatio:g}=r;e.onIntersect?.({boundingClientRect:c,intersectionRatio:g})})},{threshold:K(.005)});return C(()=>{!d||o.observe(d)}),y(()=>o.disconnect()),(()=>{const n=Z(),r=n.firstChild,c=r.nextSibling,g=d;typeof g=="function"?w(g,n):d=n,r.style.setProperty("position","absolute"),r.style.setProperty("z-index","10"),r.style.setProperty("padding","8px"),r.style.setProperty("font-size","16px"),r.style.setProperty("border-radius","5px"),r.style.setProperty("backdrop-filter","blur(25px)"),U(r,()=>e.id),c.addEventListener("error",l),c.addEventListener("load",u);const m=t;return typeof m=="function"?w(m,c):t=c,z(f=>{const h=P.image,I={[P.unload]:a()==="unload",[P.loading]:a()==="loading"},v=e.id,p=e.src,x=e.alt;return h!==f._v$&&B(n,f._v$=h),f._v$2=D(n,I,f._v$2),v!==f._v$3&&b(n,"data-id",f._v$3=v),p!==f._v$4&&b(c,"src",f._v$4=p),x!==f._v$5&&b(c,"alt",f._v$5=x),f},{_v$:void 0,_v$2:void 0,_v$3:void 0,_v$4:void 0,_v$5:void 0}),n})()},T=e=>JSON.stringify(e,Object.keys(e).sort()),ne=e=>{const t=V(e);window.history.pushState({},"",t)},te=()=>{const e=G();if(!Number.isNaN(Number.parseInt(e.chapterIndex,10))&&!Number.isNaN(Number.parseInt(e.pageIndex,10)))return{mangaId:e.mangaId,chapterIndex:Number.parseInt(e.chapterIndex,10),pageIndex:Number.parseInt(e.pageIndex,10)}},R=(e,t,a,s)=>{if(a===0)return[];const{pageIndex:u,chapterIndex:l}=e,i=s.find(n=>n.index===l),d=n=>{const r=R(n,t,a-1,s);return t==="prev"?[...r,n]:[n,...r]};if(t==="prev"){if(u!==1)return d({...e,pageIndex:u-1});const n=s.find(r=>r.index===i?.prevIndex);return n?d({...e,chapterIndex:n.index,pageIndex:n.total}):[]}if(typeof i?.total<"u"&&u!==i.total)return d({...e,pageIndex:u+1});const o=s.find(n=>n.index===i?.nextIndex);return o?d({...e,chapterIndex:o.index,pageIndex:1}):[]},E=(e,t)=>T(e)===T(t),S=(e,t)=>e.mangaId!==t.mangaId?!1:e.chapterIndex!==t.chapterIndex?t.chapterIndex<e.chapterIndex:t.pageIndex<e.pageIndex,N=e=>{if(!e)return;const t=[...e.children].map(a=>{try{const s=JSON.parse(a.dataset.id??"null");if(!s)return;const{top:u,height:l}=a.getBoundingClientRect();return{pageInfo:s,height:l,clientTop:u,element:a}}catch{return}});if(!t.includes(void 0))return t.filter(a=>!!a)},A=(e,t)=>e.reduce((a,s)=>a+s.height,-t),M=2,re=()=>{const e=q(),[t,a]=O(te()),s=L(()=>{if(e.state!=="ready")return;const i=t();if(!!i)return e().find(d=>d.id===i.mangaId)}),u=L(()=>{const i=t();if(!i)return[];const d=s();return d?[...R(i,"prev",M,d.chapters),i,...R(i,"next",M,d.chapters)]:[]});return{mangaInfo:s,readingInfo:t,displayPageImages:u,handleReadingInfoChange:(i,d)=>{const o=t();if(!o)return;const n=s();if(!n)return;const r=R(o,i,1,n.chapters)[0];!r||(a(r),ne(r),d?.())},resourceState:e.state,isLoading:e.loading}},ae="_read-view_v2xka_1",oe={readView:ae},se=F("<div>"),ie=.25,ue=()=>{const{isLoading:e,readingInfo:t,displayPageImages:a,handleReadingInfoChange:s}=re();let u,l;C(()=>{const o=t();if(!o)return;const n=N(l);if(!n)return;const r=n.find(c=>E(c.pageInfo,o));u=0,requestAnimationFrame(()=>{r?.element.scrollIntoView(!0)})});const i=o=>{const n=t();if(!n||!S(n,o))return;const r=N(l);if(!r)return;const c=r.filter(g=>S(n,g.pageInfo));console.log("\u{1F35F}","handlePageStartLoad",{currentReading:n,currentReadingElementClientTop:u},c),requestAnimationFrame(()=>{l?.scrollTo({top:A(c,u)})})},d=o=>{const{pageInfo:n,boundingClientRect:r,intersectionRatio:c}=o,g=t();if(!g||!E(g,n)||u===r.top)return;if(c>=ie){u=r.top;return}const m=r.top>0?"prev":"next",f=u,h=g;s(m,()=>requestAnimationFrame(()=>{const I=N(l);if(!I)return;const v=I.filter(_=>S(h,_.pageInfo)),p=I.findIndex(_=>E(g,_.pageInfo));if(p===-1)return;const x=m==="prev"?Math.max(p-1,-1):Math.min(p+1,I.length),k=I[x];console.log("\u{1F986}","intersect","after-update",{clientTopBeforeUpdate:f,currentReadingBeforeUpdate:h,nextReadingElement:k},v),l?.scrollTo({top:A(v,f)}),u=k.clientTop}))};return $(j,{when:!e,get children(){const o=se(),n=l;return typeof n=="function"?w(n,o):l=o,U(o,$(J,{get each(){return a()},children:r=>$(ee,{get id(){return T(r)},get src(){return H.getPageImage(r)},containerRef:l,onLoadStart:()=>i(r),onIntersect:c=>d({...c,pageInfo:r})})})),z(()=>B(o,oe.readView)),o}})};export{ue as default};
