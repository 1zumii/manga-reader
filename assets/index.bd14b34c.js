import{e as M,o as _,k as O,a as z,b as J,f as F,s as E,t as U,u as C,l as k,h as D,m as w,n as G,c as S,i as V,F as q,S as H}from"./index.8a1aea43.js";import{U as j}from"./url-transformer.6b2c128d.js";const K=e=>{if(e<=0||e>=1)return[];const t=[];let a=0;for(;a<1;)t.push(a),a+=e;return t.push(1),t},Q="_root_19szn_1",W="_image_19szn_50",X="_unload_19szn_57",Y="_loading_19szn_77",y={root:Q,image:W,unload:X,loading:Y},Z=U("<div><img>"),ee=e=>{let t;const[a,s]=M("unload");_(()=>{!t||(t.src="")});const c=()=>{s("loaded"),e.onLoaded?.()},l=()=>{s("error"),e.onError?.()},i=new ResizeObserver(n=>{n.forEach(r=>{const g=r.contentBoxSize[0].blockSize;a()!=="unload"||g===0||(e.onLoadStart?.(),s("loading"))})});O(()=>{!t||i.observe(t)}),_(()=>i.disconnect());let d;const o=new IntersectionObserver(n=>{n.forEach(r=>{const{boundingClientRect:g,intersectionRatio:f,isIntersecting:u}=r;e.onIntersect?.({boundingClientRect:g,intersectionRatio:f,isIntersecting:u})})},{threshold:K(.001)});return O(()=>{!d||o.observe(d)}),_(()=>o.disconnect()),(()=>{const n=Z(),r=n.firstChild,g=d;typeof g=="function"?C(g,n):d=n,r.addEventListener("error",l),r.addEventListener("load",c);const f=t;return typeof f=="function"?C(f,r):t=r,z(u=>{const m=y.image,h={[y.unload]:a()==="unload",[y.loading]:a()==="loading"},I=e.id,v=e.src,p=e.alt;return m!==u._v$&&J(n,u._v$=m),u._v$2=F(n,h,u._v$2),I!==u._v$3&&E(n,"data-id",u._v$3=I),v!==u._v$4&&E(r,"src",u._v$4=v),p!==u._v$5&&E(r,"alt",u._v$5=p),u},{_v$:void 0,_v$2:void 0,_v$3:void 0,_v$4:void 0,_v$5:void 0}),n})()},P=e=>JSON.stringify(e,Object.keys(e).sort()),ne=()=>{const e=k();if(!Number.isNaN(Number.parseInt(e.chapterIndex,10))&&!Number.isNaN(Number.parseInt(e.pageIndex,10)))return{mangaId:e.mangaId,chapterIndex:Number.parseInt(e.chapterIndex,10),pageIndex:Number.parseInt(e.pageIndex,10)}},x=(e,t,a,s)=>{if(a===0)return[];const{pageIndex:c,chapterIndex:l}=e,i=s.find(n=>n.index===l),d=n=>{const r=x(n,t,a-1,s);return t==="prev"?[...r,n]:[n,...r]};if(t==="prev"){if(c!==1)return d({...e,pageIndex:c-1});const n=s.find(r=>r.index===i?.prevIndex);return n?d({...e,chapterIndex:n.index,pageIndex:n.total}):[]}if(typeof i?.total<"u"&&c!==i.total)return d({...e,pageIndex:c+1});const o=s.find(n=>n.index===i?.nextIndex);return o?d({...e,chapterIndex:o.index,pageIndex:1}):[]},N=(e,t)=>P(e)===P(t),$=(e,t)=>e.mangaId!==t.mangaId?!1:e.chapterIndex!==t.chapterIndex?t.chapterIndex<e.chapterIndex:t.pageIndex<e.pageIndex,b=e=>{if(!e)return;const t=[...e.children].map(a=>{try{const s=JSON.parse(a.dataset.id??"null");if(!s)return;const{top:c,height:l}=a.getBoundingClientRect();return{pageInfo:s,height:l,clientTop:c,element:a}}catch{return}});if(!t.includes(void 0))return t.filter(a=>!!a)},A=(e,t)=>e.reduce((a,s)=>a+s.height,-t),L=2,te=()=>{const e=D(),[t,a]=M(ne()),s=w(()=>{if(e.state!=="ready")return;const i=t();if(!!i)return e().find(d=>d.id===i.mangaId)}),c=w(()=>{const i=t();if(!i)return[];const d=s();return d?[...x(i,"prev",L,d.chapters),i,...x(i,"next",L,d.chapters)]:[]});return{mangaInfo:s,readingInfo:t,displayPageImages:c,handleReadingInfoChange:(i,d)=>{const o=t();if(!o)return;const n=s();if(!n)return;const r=x(o,i,1,n.chapters)[0];!r||(a(r),G(r),d?.())},resourceState:e.state,isLoading:e.loading}},re="_read-view_v2xka_1",ae={readView:re},oe=U("<div>"),se=.25,ce=()=>{const{isLoading:e,readingInfo:t,displayPageImages:a,handleReadingInfoChange:s}=te();let c,l;O(()=>{const o=t();if(!o)return;const n=b(l);if(!n)return;const r=n.find(g=>N(g.pageInfo,o));c=0,requestAnimationFrame(()=>{r?.element.scrollIntoView(!0)})});const i=o=>{const n=t();if(!n||!$(n,o))return;const r=b(l);if(!r)return;const g=r.filter(f=>$(n,f.pageInfo));requestAnimationFrame(()=>{l?.scrollTo({top:A(g,c)})})},d=o=>{const{pageInfo:n,boundingClientRect:r,intersectionRatio:g}=o,f=t();if(!f||!N(f,n)||c===r.top||(c=r.top,console.log("\u274E",[f.chapterIndex,f.pageIndex],{currentReadingElementClientTop:c,intersectionRatio:g}),g>=se))return;const u=r.top>0?"prev":"next",m=c,h=f;s(u,()=>requestAnimationFrame(()=>{const I=b(l);if(!I)return;const v=I.filter(R=>$(h,R.pageInfo)),p=I.findIndex(R=>N(f,R.pageInfo));if(p===-1)return;const B=u==="prev"?Math.max(p-1,-1):Math.min(p+1,I.length),T=I[B];console.log("\u{1F35F}",[h.chapterIndex,h.pageIndex],{clientTopBeforeUpdate:m,nextReadingElement:JSON.parse(JSON.stringify(T)),previousElements:JSON.parse(JSON.stringify(v)),displayElements:JSON.parse(JSON.stringify(I))}),l?.scrollTo({top:A(v,m)}),c=T.clientTop}))};return S(H,{when:!e,get children(){const o=oe(),n=l;return typeof n=="function"?C(n,o):l=o,V(o,S(q,{get each(){return a()},children:r=>S(ee,{get id(){return P(r)},get src(){return j.getPageImage(r)},containerRef:l,onLoadStart:()=>i(r),onIntersect:g=>d({...g,pageInfo:r})})})),z(()=>J(o,ae.readView)),o}})};export{ce as default};
