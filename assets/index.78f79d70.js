import{e as A,o as _,j as C,a as M,b as O,f as z,s as $,t as U,u as w,k as D,g as G,h as V,l as T,c as b,i as q,F as J,S as j}from"./index.4dccaccd.js";import{U as H}from"./url-transformer.6b2c128d.js";const K=e=>{if(e<=0||e>=1)return[];const t=[];let a=0;for(;a<1;)t.push(a),a+=e;return t.push(1),t},Q="_root_15f8k_1",W="_image_15f8k_36",X="_unload_15f8k_43",Y="_loading_15f8k_63",E={root:Q,image:W,unload:X,loading:Y},Z=U("<div><img>"),ee=e=>{let t;const[a,s]=A("unload");_(()=>{!t||(t.src="")});const c=()=>{s("loaded"),e.onLoaded?.()},u=()=>{s("error"),e.onError?.()},i=new ResizeObserver(n=>{n.forEach(r=>{const l=r.contentBoxSize[0].blockSize;a()!=="unload"||l===0||(e.onLoadStart?.(),s("loading"))})});C(()=>{!t||i.observe(t)}),_(()=>i.disconnect());let d;const o=new IntersectionObserver(n=>{n.forEach(r=>{if(!r.isIntersecting)return;const{boundingClientRect:l,intersectionRatio:g}=r;e.onIntersect?.({boundingClientRect:l,intersectionRatio:g})})},{threshold:K(.01)});return C(()=>{!d||o.observe(d)}),_(()=>o.disconnect()),(()=>{const n=Z(),r=n.firstChild,l=d;typeof l=="function"?w(l,n):d=n,r.addEventListener("error",u),r.addEventListener("load",c);const g=t;return typeof g=="function"?w(g,r):t=r,M(f=>{const p=E.image,x={[E.unload]:a()==="unload",[E.loading]:a()==="loading"},I=e.id,h=e.src,m=e.alt;return p!==f._v$&&O(n,f._v$=p),f._v$2=z(n,x,f._v$2),I!==f._v$3&&$(n,"data-id",f._v$3=I),h!==f._v$4&&$(r,"src",f._v$4=h),m!==f._v$5&&$(r,"alt",f._v$5=m),f},{_v$:void 0,_v$2:void 0,_v$3:void 0,_v$4:void 0,_v$5:void 0}),n})()},P=e=>JSON.stringify(e,Object.keys(e).sort()),ne=e=>{const t=G(e);window.history.pushState({},"",t)},te=()=>{const e=D();if(!Number.isNaN(Number.parseInt(e.chapterIndex,10))&&!Number.isNaN(Number.parseInt(e.pageIndex,10)))return{mangaId:e.mangaId,chapterIndex:Number.parseInt(e.chapterIndex,10),pageIndex:Number.parseInt(e.pageIndex,10)}},v=(e,t,a,s)=>{if(a===0)return[];const{pageIndex:c,chapterIndex:u}=e,i=s.find(n=>n.index===u),d=n=>{const r=v(n,t,a-1,s);return t==="prev"?[...r,n]:[n,...r]};if(t==="prev"){if(c!==1)return d({...e,pageIndex:c-1});const n=s.find(r=>r.index===i?.prevIndex);return n?d({...e,chapterIndex:n.index,pageIndex:n.total}):[]}if(typeof i?.total<"u"&&c!==i.total)return d({...e,pageIndex:c+1});const o=s.find(n=>n.index===i?.nextIndex);return o?d({...e,chapterIndex:o.index,pageIndex:1}):[]},y=(e,t)=>P(e)===P(t),S=(e,t)=>e.mangaId!==t.mangaId?!1:e.chapterIndex!==t.chapterIndex?t.chapterIndex<e.chapterIndex:t.pageIndex<e.pageIndex,N=e=>{if(!e)return;const t=[...e.children].map(a=>{try{const s=JSON.parse(a.dataset.id??"null");if(!s)return;const{top:c,height:u}=a.getBoundingClientRect();return{pageInfo:s,height:u,clientTop:c,element:a}}catch{return}});if(!t.includes(void 0))return t.filter(a=>!!a)},k=(e,t)=>e.reduce((a,s)=>a+s.height,-t),L=2,re=()=>{const e=V(),[t,a]=A(te()),s=T(()=>{if(e.state!=="ready")return;const i=t();if(!!i)return e().find(d=>d.id===i.mangaId)}),c=T(()=>{const i=t();if(!i)return[];const d=s();return d?[...v(i,"prev",L,d.chapters),i,...v(i,"next",L,d.chapters)]:[]});return{mangaInfo:s,readingInfo:t,displayPageImages:c,handleReadingInfoChange:(i,d)=>{const o=t();if(!o)return;const n=s();if(!n)return;const r=v(o,i,1,n.chapters)[0];!r||(a(r),ne(r),d?.())},resourceState:e.state,isLoading:e.loading}},ae="_read-view_v2xka_1",oe={readView:ae},se=U("<div>"),ie=.25,ue=()=>{const{isLoading:e,readingInfo:t,displayPageImages:a,handleReadingInfoChange:s}=re();let c,u;C(()=>{const o=t();if(!o)return;const n=N(u);if(!n)return;const r=n.find(l=>y(l.pageInfo,o));c=0,requestAnimationFrame(()=>{r?.element.scrollIntoView(!0)})});const i=o=>{const n=t();if(!n||!S(n,o))return;const r=N(u);if(!r)return;const l=r.filter(g=>S(n,g.pageInfo));requestAnimationFrame(()=>{u?.scrollTo({top:k(l,c)})})},d=o=>{const{pageInfo:n,boundingClientRect:r,intersectionRatio:l}=o,g=t();if(!g||!y(g,n))return;if(l>=ie){c=r.top;return}const f=r.top>0?"prev":"next",p=c,x=g;s(f,()=>requestAnimationFrame(()=>{const I=N(u);if(!I)return;const h=I.filter(R=>S(x,R.pageInfo)),m=I.findIndex(R=>y(g,R.pageInfo));if(m===-1)return;const B=f==="prev"?Math.max(m-1,-1):Math.min(m+1,I.length),F=I[B];u?.scrollTo({top:k(h,p)}),c=F.clientTop}))};return b(j,{when:!e,get children(){const o=se(),n=u;return typeof n=="function"?w(n,o):u=o,q(o,b(J,{get each(){return a()},children:r=>b(ee,{get id(){return P(r)},get src(){return H.getPageImage(r)},containerRef:u,onLoadStart:()=>i(r),onIntersect:l=>d({...l,pageInfo:r})})})),M(()=>O(o,oe.readView)),o}})};export{ue as default};
