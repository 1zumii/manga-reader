import{e as J,o as _,k as O,i as U,a as k,b as L,f as F,s as b,t as B,u as w,l as D,h as G,m as z,n as V,c as E,F as q,S as H}from"./index.75cad4e8.js";import{U as j}from"./url-transformer.6b2c128d.js";const K=e=>{if(e<=0||e>=1)return[];const r=[];let o=0;for(;o<1;)r.push(o),o+=e;return r.push(1),r},Q="_root_19szn_1",W="_image_19szn_50",X="_unload_19szn_57",Y="_loading_19szn_77",P={root:Q,image:W,unload:X,loading:Y},Z=B("<div><pre></pre><img>"),ee=e=>{let r;const[o,a]=J("unload");_(()=>{!r||(r.src="")});const l=()=>{a("loaded"),e.onLoaded?.()},u=()=>{a("error"),e.onError?.()},i=new ResizeObserver(t=>{t.forEach(n=>{const c=n.contentBoxSize[0].blockSize;o()!=="unload"||c===0||(e.onLoadStart?.(),a("loading"))})});O(()=>{!r||i.observe(r)}),_(()=>i.disconnect());let d;const s=new IntersectionObserver(t=>{t.forEach(n=>{const{boundingClientRect:c,intersectionRatio:g,isIntersecting:I}=n;e.onIntersect?.({boundingClientRect:c,intersectionRatio:g,isIntersecting:I})})},{threshold:K(.001)});return O(()=>{!d||s.observe(d)}),_(()=>s.disconnect()),(()=>{const t=Z(),n=t.firstChild,c=n.nextSibling,g=d;typeof g=="function"?w(g,t):d=t,n.style.setProperty("position","absolute"),n.style.setProperty("z-index","10"),n.style.setProperty("padding","8px"),n.style.setProperty("font-size","16px"),n.style.setProperty("border-radius","5px"),n.style.setProperty("backdrop-filter","blur(25px)"),n.style.setProperty("-webkit-backdrop-filter","blur(25px)"),n.style.setProperty("width","100%"),n.style.setProperty("overflow-x","scroll"),U(n,()=>e.id),c.addEventListener("error",u),c.addEventListener("load",l);const I=r;return typeof I=="function"?w(I,c):r=c,k(f=>{const m=P.image,p={[P.unload]:o()==="unload",[P.loading]:o()==="loading"},x=e.id,h=e.src,v=e.alt;return m!==f._v$&&L(t,f._v$=m),f._v$2=F(t,p,f._v$2),x!==f._v$3&&b(t,"data-id",f._v$3=x),h!==f._v$4&&b(c,"src",f._v$4=h),v!==f._v$5&&b(c,"alt",f._v$5=v),f},{_v$:void 0,_v$2:void 0,_v$3:void 0,_v$4:void 0,_v$5:void 0}),t})()},C=e=>JSON.stringify(e,Object.keys(e).sort()),ne=()=>{const e=D();if(!Number.isNaN(Number.parseInt(e.chapterIndex,10))&&!Number.isNaN(Number.parseInt(e.pageIndex,10)))return{mangaId:e.mangaId,chapterIndex:Number.parseInt(e.chapterIndex,10),pageIndex:Number.parseInt(e.pageIndex,10)}},R=(e,r,o,a)=>{if(o===0)return[];const{pageIndex:l,chapterIndex:u}=e,i=a.find(t=>t.index===u),d=t=>{const n=R(t,r,o-1,a);return r==="prev"?[...n,t]:[t,...n]};if(r==="prev"){if(l!==1)return d({...e,pageIndex:l-1});const t=a.find(n=>n.index===i?.prevIndex);return t?d({...e,chapterIndex:t.index,pageIndex:t.total}):[]}if(typeof i?.total<"u"&&l!==i.total)return d({...e,pageIndex:l+1});const s=a.find(t=>t.index===i?.nextIndex);return s?d({...e,chapterIndex:s.index,pageIndex:1}):[]},S=(e,r)=>C(e)===C(r),N=(e,r)=>e.mangaId!==r.mangaId?!1:e.chapterIndex!==r.chapterIndex?r.chapterIndex<e.chapterIndex:r.pageIndex<e.pageIndex,$=e=>{if(!e)return;const r=[...e.children].map(o=>{try{const a=JSON.parse(o.dataset.id??"null");if(!a)return;const{top:l,height:u}=o.getBoundingClientRect();return{pageInfo:a,height:u,clientTop:l,element:o}}catch{return}});if(!r.includes(void 0))return r.filter(o=>!!o)},A=(e,r)=>e.reduce((o,a)=>o+a.height,-r),M=2,te=()=>{const e=G(),[r,o]=J(ne()),a=z(()=>{if(e.state!=="ready")return;const i=r();if(!!i)return e().find(d=>d.id===i.mangaId)}),l=z(()=>{const i=r();if(!i)return[];const d=a();return d?[...R(i,"prev",M,d.chapters),i,...R(i,"next",M,d.chapters)]:[]});return{mangaInfo:a,mangaResource:e,readingInfo:r,displayPageImages:l,handleReadingInfoChange:(i,d)=>{const s=r();if(!s)return;const t=a();if(!t)return;const n=R(s,i,1,t.chapters)[0];!n||(o(n),V(n),d?.())}}},re="_read-view_v2xka_1",oe={readView:re},se=B("<div>"),ae=.25,ce=()=>{const{mangaResource:e,readingInfo:r,displayPageImages:o,handleReadingInfoChange:a}=te();let l,u;O(()=>{const s=r();if(!s)return;const t=$(u);if(!t)return;const n=t.find(c=>S(c.pageInfo,s));l=0,requestAnimationFrame(()=>{n?.element.scrollIntoView(!0)})});const i=s=>{const t=r();if(!t||!N(t,s))return;const n=$(u);if(!n)return;const c=n.filter(g=>N(t,g.pageInfo));requestAnimationFrame(()=>{u?.scrollTo({top:A(c,l)})})},d=s=>{const{pageInfo:t,boundingClientRect:n,intersectionRatio:c}=s,g=r();if(!g||!S(g,t)||l===n.top||(l=n.top,console.log("\u274E",[g.chapterIndex,g.pageIndex],{currentReadingElementClientTop:l,intersectionRatio:c,height:n.height}),c>=ae))return;const I=n.top>0?"prev":"next",f=l,m=g;a(I,()=>requestAnimationFrame(()=>{const p=$(u);if(!p)return;const x=p.filter(y=>N(m,y.pageInfo)),h=p.findIndex(y=>S(g,y.pageInfo));if(h===-1)return;const v=I==="prev"?Math.max(h-1,-1):Math.min(h+1,p.length),T=p[v];console.log("\u{1F35F}",[m.chapterIndex,m.pageIndex],{clientTopBeforeUpdate:f,nextReadingElement:JSON.parse(JSON.stringify(T)),previousElements:JSON.parse(JSON.stringify(x)),displayElements:JSON.parse(JSON.stringify(p))}),u?.scrollTo({top:A(x,f)}),l=T.clientTop}))};return E(H,{get when(){return!e.loading},get children(){const s=se(),t=u;return typeof t=="function"?w(t,s):u=s,U(s,E(q,{get each(){return o()},children:n=>E(ee,{get id(){return C(n)},get src(){return j.getPageImage(n)},containerRef:u,onLoadStart:()=>i(n),onIntersect:c=>d({...c,pageInfo:n})})})),k(()=>L(s,oe.readView)),s}})};export{ce as default};
