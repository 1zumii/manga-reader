import{e as O,o as _,k as C,a as z,b as U,f as k,s as $,t as L,u as P,l as D,h as G,m as w,n as V,c as b,i as q,F as J,S as H}from"./index.2722feb5.js";import{U as j}from"./url-transformer.6b2c128d.js";const K=e=>{if(e<=0||e>=1)return[];const t=[];let a=0;for(;a<1;)t.push(a),a+=e;return t.push(1),t},Q="_root_19szn_1",W="_image_19szn_50",X="_unload_19szn_57",Y="_loading_19szn_77",E={root:Q,image:W,unload:X,loading:Y},Z=L("<div><img>"),ee=e=>{let t;const[a,s]=O("unload");_(()=>{!t||(t.src="")});const c=()=>{s("loaded"),e.onLoaded?.()},l=()=>{s("error"),e.onError?.()},i=new ResizeObserver(n=>{n.forEach(r=>{const f=r.contentBoxSize[0].blockSize;a()!=="unload"||f===0||(e.onLoadStart?.(),s("loading"))})});C(()=>{!t||i.observe(t)}),_(()=>i.disconnect());let d;const o=new IntersectionObserver(n=>{n.forEach(r=>{const{boundingClientRect:f,intersectionRatio:g,isIntersecting:u}=r;e.onIntersect?.({boundingClientRect:f,intersectionRatio:g,isIntersecting:u})})},{threshold:K(1e-4)});return C(()=>{!d||o.observe(d)}),_(()=>o.disconnect()),(()=>{const n=Z(),r=n.firstChild,f=d;typeof f=="function"?P(f,n):d=n,r.addEventListener("error",l),r.addEventListener("load",c);const g=t;return typeof g=="function"?P(g,r):t=r,z(u=>{const p=E.image,x={[E.unload]:a()==="unload",[E.loading]:a()==="loading"},I=e.id,h=e.src,m=e.alt;return p!==u._v$&&U(n,u._v$=p),u._v$2=k(n,x,u._v$2),I!==u._v$3&&$(n,"data-id",u._v$3=I),h!==u._v$4&&$(r,"src",u._v$4=h),m!==u._v$5&&$(r,"alt",u._v$5=m),u},{_v$:void 0,_v$2:void 0,_v$3:void 0,_v$4:void 0,_v$5:void 0}),n})()},T=e=>JSON.stringify(e,Object.keys(e).sort()),ne=()=>{const e=D();if(!Number.isNaN(Number.parseInt(e.chapterIndex,10))&&!Number.isNaN(Number.parseInt(e.pageIndex,10)))return{mangaId:e.mangaId,chapterIndex:Number.parseInt(e.chapterIndex,10),pageIndex:Number.parseInt(e.pageIndex,10)}},v=(e,t,a,s)=>{if(a===0)return[];const{pageIndex:c,chapterIndex:l}=e,i=s.find(n=>n.index===l),d=n=>{const r=v(n,t,a-1,s);return t==="prev"?[...r,n]:[n,...r]};if(t==="prev"){if(c!==1)return d({...e,pageIndex:c-1});const n=s.find(r=>r.index===i?.prevIndex);return n?d({...e,chapterIndex:n.index,pageIndex:n.total}):[]}if(typeof i?.total<"u"&&c!==i.total)return d({...e,pageIndex:c+1});const o=s.find(n=>n.index===i?.nextIndex);return o?d({...e,chapterIndex:o.index,pageIndex:1}):[]},y=(e,t)=>T(e)===T(t),N=(e,t)=>e.mangaId!==t.mangaId?!1:e.chapterIndex!==t.chapterIndex?t.chapterIndex<e.chapterIndex:t.pageIndex<e.pageIndex,S=e=>{if(!e)return;const t=[...e.children].map(a=>{try{const s=JSON.parse(a.dataset.id??"null");if(!s)return;const{top:c,height:l}=a.getBoundingClientRect();return{pageInfo:s,height:l,clientTop:c,element:a}}catch{return}});if(!t.includes(void 0))return t.filter(a=>!!a)},A=(e,t)=>e.reduce((a,s)=>a+s.height,-t),M=2,te=()=>{const e=G(),[t,a]=O(ne()),s=w(()=>{if(e.state!=="ready")return;const i=t();if(!!i)return e().find(d=>d.id===i.mangaId)}),c=w(()=>{const i=t();if(!i)return[];const d=s();return d?[...v(i,"prev",M,d.chapters),i,...v(i,"next",M,d.chapters)]:[]});return{mangaInfo:s,mangaResource:e,readingInfo:t,displayPageImages:c,handleReadingInfoChange:(i,d)=>{const o=t();if(!o)return;const n=s();if(!n)return;const r=v(o,i,1,n.chapters)[0];!r||(a(r),V(r),d?.())}}},re="_read-view_v2xka_1",ae={readView:re},oe=L("<div>"),se=.25,ce=()=>{const{mangaResource:e,readingInfo:t,displayPageImages:a,handleReadingInfoChange:s}=te();let c,l;C(()=>{const o=t();if(!o)return;const n=S(l);if(!n)return;const r=n.find(f=>y(f.pageInfo,o));c=0,requestAnimationFrame(()=>{r?.element.scrollIntoView(!0)})});const i=o=>{const n=t();if(!n||!N(n,o))return;const r=S(l);if(!r)return;const f=r.filter(g=>N(n,g.pageInfo));requestAnimationFrame(()=>{l?.scrollTo({top:A(f,c)})})},d=o=>{const{pageInfo:n,boundingClientRect:r,intersectionRatio:f}=o,g=t();if(!g||!y(g,n)||c===r.top||(c=r.top,f>=se))return;const u=r.top>0?"prev":"next",p=c,x=g;s(u,()=>requestAnimationFrame(()=>{const I=S(l);if(!I)return;const h=I.filter(R=>N(x,R.pageInfo)),m=I.findIndex(R=>y(g,R.pageInfo));if(m===-1)return;const B=u==="prev"?Math.max(m-1,-1):Math.min(m+1,I.length),F=I[B];l?.scrollTo({top:A(h,p)}),c=F.clientTop}))};return b(H,{get when(){return!e.loading},get children(){const o=oe(),n=l;return typeof n=="function"?P(n,o):l=o,q(o,b(J,{get each(){return a()},children:r=>b(ee,{get id(){return T(r)},get src(){return j.getPageImage(r)},containerRef:l,onLoadStart:()=>i(r),onIntersect:f=>d({...f,pageInfo:r})})})),z(()=>U(o,ae.readView)),o}})};export{ce as default};
