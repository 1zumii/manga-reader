import{e as M,o as _,k as b,i as z,a as A,b as J,f as D,s as N,t as U,u as S,l as B,h as k,m as w,n as F,c as y,F as G,S as L}from"./index.076c8de1.js";import{U as V}from"./url-transformer.6b2c128d.js";const q=e=>{if(e<=0||e>=1)return[];const t=[];let o=0;for(;o<1;)t.push(o),o+=e;return t.push(1),t},H="_root_19szn_1",j="_image_19szn_50",K="_unload_19szn_57",Q="_loading_19szn_77",E={root:H,image:j,unload:K,loading:Q},W=U("<div><img>"),X=!1,Y=e=>{let t;const[o,s]=M("unload");_(()=>{!t||(t.src="")});const d=()=>{s("loaded"),e.onLoaded?.()},g=()=>{s("error"),e.onError?.()},i=new ResizeObserver(n=>{n.forEach(a=>{const l=a.contentBoxSize[0].blockSize;o()!=="unload"||l===0||(e.onLoadStart?.(),s("loading"))})});b(()=>{!t||i.observe(t)}),_(()=>i.disconnect());let r;const c=new IntersectionObserver(n=>{n.forEach(a=>{const{boundingClientRect:l,intersectionRatio:f,isIntersecting:u}=a;e.onIntersect?.({boundingClientRect:l,intersectionRatio:f,isIntersecting:u})})},{threshold:q(1e-4)});return b(()=>{!r||c.observe(r)}),_(()=>c.disconnect()),(()=>{const n=W(),a=n.firstChild,l=r;typeof l=="function"?S(l,n):r=n,z(n,X,a),a.addEventListener("error",g),a.addEventListener("load",d);const f=t;return typeof f=="function"?S(f,a):t=a,A(u=>{const p=E.image,I={[E.unload]:o()==="unload",[E.loading]:o()==="loading"},h=e.id,m=e.src,v=e.alt;return p!==u._v$&&J(n,u._v$=p),u._v$2=D(n,I,u._v$2),h!==u._v$3&&N(n,"data-id",u._v$3=h),m!==u._v$4&&N(a,"src",u._v$4=m),v!==u._v$5&&N(a,"alt",u._v$5=v),u},{_v$:void 0,_v$2:void 0,_v$3:void 0,_v$4:void 0,_v$5:void 0}),n})()},O=e=>JSON.stringify(e,Object.keys(e).sort()),Z=()=>{const e=B();if(!Number.isNaN(Number.parseInt(e.chapterIndex,10))&&!Number.isNaN(Number.parseInt(e.pageIndex,10)))return{mangaId:e.mangaId,chapterIndex:Number.parseInt(e.chapterIndex,10),pageIndex:Number.parseInt(e.pageIndex,10)}},x=(e,t,o,s)=>{if(o===0)return[];const{pageIndex:d,chapterIndex:g}=e,i=s.find(n=>n.index===g),r=n=>{const a=x(n,t,o-1,s);return t==="prev"?[...a,n]:[n,...a]};if(t==="prev"){if(d!==1)return r({...e,pageIndex:d-1});const n=s.find(a=>a.index===i?.prevIndex);return n?r({...e,chapterIndex:n.index,pageIndex:n.total}):[]}if(typeof i?.total<"u"&&d!==i.total)return r({...e,pageIndex:d+1});const c=s.find(n=>n.index===i?.nextIndex);return c?r({...e,chapterIndex:c.index,pageIndex:1}):[]},$=(e,t)=>O(e)===O(t),ee=(e,t)=>e.mangaId!==t.mangaId?!1:e.chapterIndex!==t.chapterIndex?t.chapterIndex<e.chapterIndex:t.pageIndex<e.pageIndex,P=e=>{if(!e)return;const t=[...e.children].map(o=>{try{const s=JSON.parse(o.dataset.id??"null");if(!s)return;const{top:d,height:g}=o.getBoundingClientRect();return{pageInfo:s,height:g,clientTop:d,element:o}}catch{return}});if(!t.includes(void 0))return t.filter(o=>!!o)},ne=(e,t)=>e.reduce((o,s)=>o+s.height,-t),T=2,te=()=>{const e=k(),[t,o]=M(Z()),s=w(()=>{if(e.state!=="ready")return;const i=t();if(!!i)return e().find(r=>r.id===i.mangaId)}),d=w(()=>{const i=t();if(!i)return[];const r=s();return r?[...x(i,"prev",T,r.chapters),i,...x(i,"next",T,r.chapters)]:[]});return{mangaInfo:s,mangaResource:e,readingInfo:t,displayPageImages:d,handleReadingInfoChange:(i,r)=>{const c=t();if(!c)return;const n=s();if(!n)return;const a=x(c,i,1,n.chapters)[0];!a||(o(a),F(a),r?.())}}},re="_read-view_v2xka_1",ae={readView:re},oe=U("<div>"),se=.25,ce=()=>{const{mangaResource:e,readingInfo:t,displayPageImages:o,handleReadingInfoChange:s}=te();let d,g;b(()=>{const r=t();if(!r)return;const c=P(g);if(!c)return;const n=c.find(a=>$(a.pageInfo,r));d=0,requestAnimationFrame(()=>{n?.element.scrollIntoView(!0)})});const i=r=>{const{pageInfo:c,boundingClientRect:n,intersectionRatio:a}=r,l=t();if(!l||!$(l,c)||d===n.top||(d=n.top,console.log(Date.now(),"\u274E",[l.chapterIndex,l.pageIndex],{currentReadingElementClientTop:d,intersectionRatio:a,height:n.height}),a>=se))return;const f=n.top>0?"prev":"next",u=d,p=l;s(f,()=>requestAnimationFrame(()=>{const I=P(g);if(!I)return;const h=I.filter(R=>ee(p,R.pageInfo)),m=I.findIndex(R=>$(l,R.pageInfo));if(m===-1)return;const v=f==="prev"?Math.max(m-1,-1):Math.min(m+1,I.length),C=I[v];console.log(Date.now(),"\u{1F35F}",[p.chapterIndex,p.pageIndex],{clientTopBeforeUpdate:u,nextReadingElement:JSON.parse(JSON.stringify(C)),previousElements:JSON.parse(JSON.stringify(h)),displayElements:JSON.parse(JSON.stringify(I))}),g?.scrollTo({top:ne(h,u)}),d=C.clientTop}))};return y(L,{get when(){return!e.loading},get children(){const r=oe(),c=g;return typeof c=="function"?S(c,r):g=r,z(r,y(G,{get each(){return o()},children:n=>y(Y,{get id(){return O(n)},get src(){return V.getPageImage(n)},containerRef:g,onIntersect:a=>i({...a,pageInfo:n})})})),A(()=>J(r,ae.readView)),r}})};export{ce as default};
