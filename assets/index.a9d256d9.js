import{e as O,o as y,j as w,i as U,a as z,b as B,f as D,s as b,t as F,u as C,k as G,g as V,h as q,l as L,c as P,F as J,S as j}from"./index.b31a8716.js";import{U as H}from"./url-transformer.6b2c128d.js";const K=e=>{if(e<=0||e>=1)return[];const r=[];let o=0;for(;o<1;)r.push(o),o+=e;return r.push(1),r},Q="_root_15f8k_1",W="_image_15f8k_36",X="_unload_15f8k_43",Y="_loading_15f8k_63",$={root:Q,image:W,unload:X,loading:Y},Z=F("<div><pre></pre><img>"),ee=e=>{let r;const[o,s]=O("unload");y(()=>{!r||(r.src="")});const l=()=>{s("loaded"),e.onLoaded?.()},u=()=>{s("error"),e.onError?.()},i=new ResizeObserver(n=>{n.forEach(t=>{const c=t.contentBoxSize[0].blockSize;o()!=="unload"||c===0||(e.onLoadStart?.(),s("loading"))})});w(()=>{!r||i.observe(r)}),y(()=>i.disconnect());let d;const a=new IntersectionObserver(n=>{n.forEach(t=>{if(!t.isIntersecting)return;const{boundingClientRect:c,intersectionRatio:g}=t;e.onIntersect?.({boundingClientRect:c,intersectionRatio:g})})},{threshold:K(.005)});return w(()=>{!d||a.observe(d)}),y(()=>a.disconnect()),(()=>{const n=Z(),t=n.firstChild,c=t.nextSibling,g=d;typeof g=="function"?C(g,n):d=n,t.style.setProperty("position","absolute"),t.style.setProperty("z-index","10"),t.style.setProperty("padding","8px"),t.style.setProperty("font-size","16px"),t.style.setProperty("border-radius","5px"),t.style.setProperty("backdrop-filter","blur(25px)"),t.style.setProperty("width","100%"),t.style.setProperty("overflow-x","scroll"),U(t,()=>e.id),c.addEventListener("error",u),c.addEventListener("load",l);const m=r;return typeof m=="function"?C(m,c):r=c,z(f=>{const h=$.image,p={[$.unload]:o()==="unload",[$.loading]:o()==="loading"},v=e.id,I=e.src,x=e.alt;return h!==f._v$&&B(n,f._v$=h),f._v$2=D(n,p,f._v$2),v!==f._v$3&&b(n,"data-id",f._v$3=v),I!==f._v$4&&b(c,"src",f._v$4=I),x!==f._v$5&&b(c,"alt",f._v$5=x),f},{_v$:void 0,_v$2:void 0,_v$3:void 0,_v$4:void 0,_v$5:void 0}),n})()},T=e=>JSON.stringify(e,Object.keys(e).sort()),ne=e=>{const r=V(e);window.history.pushState({},"",r)},te=()=>{const e=G();if(!Number.isNaN(Number.parseInt(e.chapterIndex,10))&&!Number.isNaN(Number.parseInt(e.pageIndex,10)))return{mangaId:e.mangaId,chapterIndex:Number.parseInt(e.chapterIndex,10),pageIndex:Number.parseInt(e.pageIndex,10)}},R=(e,r,o,s)=>{if(o===0)return[];const{pageIndex:l,chapterIndex:u}=e,i=s.find(n=>n.index===u),d=n=>{const t=R(n,r,o-1,s);return r==="prev"?[...t,n]:[n,...t]};if(r==="prev"){if(l!==1)return d({...e,pageIndex:l-1});const n=s.find(t=>t.index===i?.prevIndex);return n?d({...e,chapterIndex:n.index,pageIndex:n.total}):[]}if(typeof i?.total<"u"&&l!==i.total)return d({...e,pageIndex:l+1});const a=s.find(n=>n.index===i?.nextIndex);return a?d({...e,chapterIndex:a.index,pageIndex:1}):[]},E=(e,r)=>T(e)===T(r),S=(e,r)=>e.mangaId!==r.mangaId?!1:e.chapterIndex!==r.chapterIndex?r.chapterIndex<e.chapterIndex:r.pageIndex<e.pageIndex,N=e=>{if(!e)return;const r=[...e.children].map(o=>{try{const s=JSON.parse(o.dataset.id??"null");if(!s)return;const{top:l,height:u}=o.getBoundingClientRect();return{pageInfo:s,height:u,clientTop:l,element:o}}catch{return}});if(!r.includes(void 0))return r.filter(o=>!!o)},A=(e,r)=>e.reduce((o,s)=>o+s.height,-r),M=2,re=()=>{const e=q(),[r,o]=O(te()),s=L(()=>{if(e.state!=="ready")return;const i=r();if(!!i)return e().find(d=>d.id===i.mangaId)}),l=L(()=>{const i=r();if(!i)return[];const d=s();return d?[...R(i,"prev",M,d.chapters),i,...R(i,"next",M,d.chapters)]:[]});return{mangaInfo:s,readingInfo:r,displayPageImages:l,handleReadingInfoChange:(i,d)=>{const a=r();if(!a)return;const n=s();if(!n)return;const t=R(a,i,1,n.chapters)[0];!t||(o(t),ne(t),d?.())},resourceState:e.state,isLoading:e.loading}},oe="_read-view_v2xka_1",ae={readView:oe},se=F("<div>"),ie=.25,le=()=>{const{isLoading:e,readingInfo:r,displayPageImages:o,handleReadingInfoChange:s}=re();let l,u;w(()=>{const a=r();if(!a)return;const n=N(u);if(!n)return;const t=n.find(c=>E(c.pageInfo,a));l=0,requestAnimationFrame(()=>{t?.element.scrollIntoView(!0)})});const i=a=>{const n=r();if(!n||!S(n,a))return;const t=N(u);if(!t)return;const c=t.filter(g=>S(n,g.pageInfo));console.log("\u{1F35F}","handlePageStartLoad",{currentReading:n,currentReadingElementClientTop:l},c),requestAnimationFrame(()=>{u?.scrollTo({top:A(c,l)})})},d=a=>{const{pageInfo:n,boundingClientRect:t,intersectionRatio:c}=a,g=r();if(!g||!E(g,n)||l===t.top)return;if(c>=ie){l=t.top;return}const m=t.top>0?"prev":"next",f=l,h=g;s(m,()=>requestAnimationFrame(()=>{const p=N(u);if(!p)return;const v=p.filter(_=>S(h,_.pageInfo)),I=p.findIndex(_=>E(g,_.pageInfo));if(I===-1)return;const x=m==="prev"?Math.max(I-1,-1):Math.min(I+1,p.length),k=p[x];console.log("\u{1F986}","intersect","after-update",{clientTopBeforeUpdate:f,currentReadingBeforeUpdate:h,nextReadingElement:k},v),u?.scrollTo({top:A(v,f)}),l=k.clientTop}))};return P(j,{when:!e,get children(){const a=se(),n=u;return typeof n=="function"?C(n,a):u=a,U(a,P(J,{get each(){return o()},children:t=>P(ee,{get id(){return T(t)},get src(){return H.getPageImage(t)},containerRef:u,onLoadStart:()=>i(t),onIntersect:c=>d({...c,pageInfo:t})})})),z(()=>B(a,ae.readView)),a}})};export{le as default};
