import{e as U,o as b,k as N,i as B,a as D,b as k,f as q,s as C,t as F,u as T,l as J,h as H,m as O,n as j,c as $,F as K,S as Q}from"./index.e2d6658e.js";import{U as W}from"./url-transformer.6b2c128d.js";const X=e=>{if(e<=0||e>=1)return[];const n=[];let a=0;for(;a<1;)n.push(a),a+=e;return n.push(1),n},Y="_root_19szn_1",Z="_image_19szn_50",ee="_unload_19szn_57",ne="_loading_19szn_77",S={root:Y,image:Z,unload:ee,loading:ne},te=F("<div><img>"),re=e=>[],oe=e=>{let n;const[a,s]=U("unload");b(()=>{!n||(n.src="")});const c=()=>{s("loaded"),e.onLoaded?.()},i=()=>{s("error"),e.onError?.()},o=new ResizeObserver(r=>{r.forEach(u=>{const f=u.contentBoxSize[0].blockSize;a()!=="unload"||f===0||(e.onLoadStart?.(),s("loading"))})});N(()=>{!n||o.observe(n)}),b(()=>o.disconnect());let d;const t=new IntersectionObserver(r=>{r.forEach(u=>{const{boundingClientRect:f,intersectionRatio:m,isIntersecting:g}=u;e.onIntersect?.({boundingClientRect:f,intersectionRatio:m,isIntersecting:g})})},{threshold:X(1e-4)});return N(()=>{!d||t.observe(d)}),b(()=>t.disconnect()),(()=>{const r=te(),u=r.firstChild,f=d;typeof f=="function"?T(f,r):d=r,B(r,()=>re(e.id),u),u.addEventListener("error",i),u.addEventListener("load",c);const m=n;return typeof m=="function"?T(m,u):n=u,D(g=>{const h=S.image,P={[S.unload]:a()==="unload",[S.loading]:a()==="loading"},v=e.id,I=e.src,x=e.alt;return h!==g._v$&&k(r,g._v$=h),g._v$2=q(r,P,g._v$2),v!==g._v$3&&C(r,"data-id",g._v$3=v),I!==g._v$4&&C(u,"src",g._v$4=I),x!==g._v$5&&C(u,"alt",g._v$5=x),g},{_v$:void 0,_v$2:void 0,_v$3:void 0,_v$4:void 0,_v$5:void 0}),r})()},y=e=>JSON.stringify(e,Object.keys(e).sort()),ae=()=>{const e=J();if(!Number.isNaN(Number.parseInt(e.chapterIndex,10))&&!Number.isNaN(Number.parseInt(e.pageIndex,10)))return{mangaId:e.mangaId,chapterIndex:Number.parseInt(e.chapterIndex,10),pageIndex:Number.parseInt(e.pageIndex,10)}},R=(e,n,a,s)=>{if(a===0)return[];const{pageIndex:l,chapterIndex:c}=e,i=s.find(t=>t.index===c),o=t=>{const r=R(t,n,a-1,s);return n==="prev"?[...r,t]:[t,...r]};if(n==="prev"){if(l!==1)return o({...e,pageIndex:l-1});const t=s.find(r=>r.index===i?.prevIndex);return t?o({...e,chapterIndex:t.index,pageIndex:t.total}):[]}if(typeof i?.total<"u"&&l!==i.total)return o({...e,pageIndex:l+1});const d=s.find(t=>t.index===i?.nextIndex);return d?o({...e,chapterIndex:d.index,pageIndex:1}):[]},E=(e,n)=>y(e)===y(n),M=(e,n)=>e.mangaId!==n.mangaId?!1:e.chapterIndex!==n.chapterIndex?n.chapterIndex<e.chapterIndex:n.pageIndex<e.pageIndex,z=e=>{if(!e)return;const n=[...e.children].map(a=>{try{const s=JSON.parse(a.dataset.id??"null");if(!s)return;const{top:l,height:c}=a.getBoundingClientRect();return{pageInfo:s,height:c,clientTop:l,element:a}}catch{return}});if(!n.includes(void 0))return n.filter(a=>!!a)},se=(e,n)=>e.reduce((a,s)=>a+s.height,-n),A=2,ie=()=>{const e=H(),[n,a]=U(ae()),s=O(()=>{if(e.state!=="ready")return;const i=n();if(!!i)return e().find(o=>o.id===i.mangaId)}),l=O(()=>{const i=n();if(!i)return[];const o=s();return o?[...R(i,"prev",A,o.chapters),i,...R(i,"next",A,o.chapters)]:[]});return{mangaInfo:s,mangaResource:e,readingInfo:n,displayPageImages:l,handleReadingInfoChange:(i,o)=>{const d=n();if(!d)return;const t=s();if(!t)return;const r=R(d,i,1,t.chapters)[0];!r||(a(r),j(r),o?.())}}},de="_read-view_v2xka_1",ce={readView:de},ue=F("<div>"),le=.25,me=()=>{const{mangaResource:e,readingInfo:n,displayPageImages:a,handleReadingInfoChange:s}=ie();let l,c;N(()=>{const o=n();if(!o)return;const d=z(c);if(!d)return;const t=d.find(r=>E(r.pageInfo,o));l=0,t?.element.scrollIntoView(!0)});const i=o=>{const{pageInfo:d,boundingClientRect:t,intersectionRatio:r}=o,u=n();if(!u||!E(u,d)||l===t.top||(l=t.top,r>=le)||!c)return;const f=t.top>0?"prev":"next",m=u,g=c.scrollTop,h=l;s(f,()=>requestAnimationFrame(()=>{if(!c)return;const v=c.scrollTop-g,I=z(c);if(!I)return;const x=I.filter(p=>M(m,p.pageInfo)),_=I.findIndex(p=>E(u,p.pageInfo));if(_===-1)return;const G=f==="prev"?Math.max(_-1,-1):Math.min(_+1,I.length),L=I[G],w=se(x,h-v);c?.scrollTo({top:w}),l=I.filter(p=>M(L.pageInfo,p.pageInfo)).reduce((p,V)=>p+V.height,-w)}))};return $(Q,{get when(){return!e.loading},get children(){const o=ue(),d=c;return typeof d=="function"?T(d,o):c=o,B(o,$(K,{get each(){return a()},children:t=>$(oe,{get id(){return y(t)},get src(){return W.getPageImage(t)},containerRef:c,onIntersect:r=>i({...r,pageInfo:t})})})),D(()=>k(o,ce.readView)),o}})};export{me as default};
